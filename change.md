# 変更点 (2025/09/06)

## 新機能

- **ToDoリストへのカテゴリー機能の追加:**
  - ToDoリストをカテゴリー別に分類・管理できる機能を追加しました。これにより、タスクの整理がより簡単になります。
  - **バックエンド:**
    - ToDo専用のカテゴリーを保存する`todo_categories`テーブルを新たに設計しました。
    - カテゴリーの追加・取得・更新・削除を行うためのAPIエンドポイント (`/api/todo-categories`) を新規に作成しました。
    - 既存のToDo関連API (`/api/todos`) を修正し、新しいカテゴリーシステムと連携するようにしました。
  - **フロントエンド:**
    - `TodoList.js`コンポーネントを全面的にリファクタリングし、他の機能と統一感のあるMaterial-UIベースのデザインに刷新しました。
    - カテゴリーの追加・編集・削除を行える管理UIを実装しました。
    - ToDoの追加・編集フォームにカテゴリー選択のドロップダウンを設置しました。
  - **注記:** この機能の利用には、データベースのスキーマ変更が必要です。

## 不具合修正

- **レート制限機能のエラーを修正:**
  - アプリケーションがプロキシ環境下で実行された場合に、レート制限ライブラリ (`express-rate-limit`) が `X-Forwarded-For` ヘッダーを信頼できずにエラーを発生させる問題を修正しました。
  - `server.js` に `app.set('trust proxy', 1);` を追加し、プロキシからのヘッダーを信頼するようExpressに指示することで、レート制限が正しく機能するようにしました。

- **家計簿のカテゴリーが追加できない問題を修正:**
  - 原因は、サーバーサイドのルーティング設定の誤りでした。カテゴリー関連のAPI (`/api/categories`) が、意図せず取引関連のAPI (`/api/transactions`) の配下に設定されていたため、フロントエンドからのリクエストが正しく処理されていませんでした。
  - この問題を解決するため、バックエンドのルーティングをリファクタリングしました。
    1. カテゴリー関連のAPIエンドポイントをすべて格納する`routes/categories.js`という新しいファイルを作成しました。
    2. `routes/transactions.js`からカテゴリー関連のロジックを新しいファイルに移動させました。
    3. `server.js`を更新し、`/api/categories`へのリクエストが新しく作成した`categoriesRouter`に正しくルーティングされるように修正しました。
  - これにより、家計簿機能におけるカテゴリーの追加、更新、削除が正常に動作するようになりました。

## 家計簿UIの大幅な改善

「家計簿」機能のユーザーインターフェースが他の画面と比べて見劣りするという問題点を解消するため、UIを全面的に刷新しました。

### 変更内容

- **Material-UIへの完全移行:**
  - `Transactions.js`コンポーネントを、プロジェクトで既に採用されているMaterial-UI (MUI) を使って全面的にリファクタリングしました。
  - `Paper`, `Box`, `Grid`, `TextField`, `Button`, `List`などのMUIコンポーネントを導入し、アプリケーション全体で統一感のあるモダンなデザインを実現しました。

- **スタイルの外部ファイル化:**
  - コンポーネント内に散在していたインラインスタイルをすべて削除し、新しく作成した`Transactions.css`に集約しました。これにより、コードの可読性と保守性が大幅に向上しました。

- **ユーザー体験 (UX) の向上:**
  - カテゴリーの編集や削除確認に使われていたブラウザ標準の`prompt`や`confirm`ダイアログを、MUIの`Dialog`コンポーネントに置き換えました。これにより、操作が中断されることのない、洗練されたユーザー体験を提供します。
  - 取引の追加や削除、エラー発生時のフィードバックを、画面の隅に表示される`Snackbar`と`Alert`コンポーネントで行うように変更しました。

- **レイアウトと構造の改善:**
  - 「今月のサマリー」「新しい取引を追加」「取引履歴」などの各セクションを`Paper`コンポーネントでカード化し、視覚的なまとまりと情報の見やすさを向上させました。
  - `Grid`コンポーネントを利用して、入力フォームやカテゴリー管理画面のレイアウトを整理し、レスポンシブデザインにも対応しやすくしました。
  - 削除や編集ボタンを、テキストではなく直感的なアイコン (`IconButton`) に変更しました。

### 期待される効果

- **デザインの一貫性:** 家計簿機能がダッシュボードの他の部分と同じデザイン言語で構築され、アプリケーション全体としての一貫性が保たれます。
- **操作性の向上:** モダンなUIコンポーネントの採用により、ユーザーはより直感的かつ快適にアプリケーションを操作できるようになります。
- **開発効率の向上:** スタイルとコンポーネントの責務が分離され、今後の機能追加や修正がより容易になります。

## ゲストログイン機能の追加

ユーザーがアカウントを作成せずにアプリケーションの機能を試せるように、ゲストとしてログインできる機能を追加しました。

### 変更内容

- **ゲストログインAPIの追加:**
  - `routes/auth.js`に`POST /api/guest-login`エンドポイントを追加しました。
  - このAPIは、`guest`という名前のユーザーをデータベースで検索または作成し、そのユーザー用のJWTトークンを返します。

- **フロントエンドへのボタン設置:**
  - `client/src/components/Login.js`のログインフォームに「ゲストとしてログイン」ボタンを追加しました。
  - このボタンをクリックすると、新たに追加されたゲストログインAPIが呼び出され、取得したトークンを使って自動的にログイン処理が行われます。

- **UIの調整:**
  - `client/src/components/Login.css`にスタイルを追加し、通常のログインボタンとゲストログインボタンが視覚的に区別できるようにしました。

### 期待される効果

- **ユーザー体験の向上:** 新規ユーザーが気軽にアプリケーションを試せるようになり、利用のハードルが下がります。
- **機能のデモンストレーション:** アカウント登録を促す前に、アプリケーションの価値をユーザーに体験してもらう機会を提供します。

# 変更点 (2025/09/05)

## サーバーサイドのコード分割

`advise.md`の提案に基づき、サーバーサイドのコード構造を改善しました。

### 変更内容

- **APIロジックの分割:**
  - `server.js`に混在していたAPI関連のロジックを、機能ごとに`routes`ディレクトリ内の以下のファイルに分割しました。
    - `routes/auth.js`: ユーザー認証 (登録、ログイン)
    - `routes/todos.js`: ToDoリスト
    - `routes/events.js`: カレンダーの予定
    - `routes/transactions.js`: 家計簿
    - `routes/user.js`: ユーザー関連 (将来的な拡張用)

- **データベース接続の分離:**
  - データベース接続設定を`db.js`ファイルに分離し、各モジュールから再利用できるようにしました。

- **認証ミドルウェアの分離:**
  - JWTを検証する認証ミドルウェアを`middleware/auth.js`に分離しました。

- **`server.js`の責務の明確化:**
  - `server.js`は、Expressサーバーの起動、ミドルウェアの読み込み、そして分割された各APIルーターのマウントという、アプリケーション全体のセットアップに責務を限定しました。

### 期待される効果

- **保守性の向上:** 機能ごとにファイルが分かれたことで、コードの特定、修正、デバッグが容易になりました。
- **可読性の向上:** ファイル名からその役割が明確になり、プロジェクト全体の構造を理解しやすくなりました。
- **拡張性の向上:** 新しいAPIを追加する際に、既存のコードへの影響を最小限に抑えつつ、新しいルートファイルを`routes`ディレクトリに追加するだけで対応できるようになりました。

## エラーハンドリングの共通化

`advise.md`の提案に基づき、エラー処理を共通化しました。

### 変更内容

- **共通エラーハンドリングミドルウェアの導入:**
  - `server.js`の末尾に、アプリケーション全体のエラーを捕捉し、一元的に処理するミドルウェアを追加しました。
  - 使用しているExpress v5の機能により、非同期処理で発生したエラーも自動的にこのミドルウェアで処理されます。

- **冗長なコードの削除:**
  - 各APIルートファイル (`routes/*.js`) に存在した個別の`try...catch`ブロックをすべて削除し、エラー処理を共通ミドルウェアに委ねました。

### 期待される効果

- **コードの簡潔化:** 各APIからエラー処理の定型コードがなくなり、本来のビジネスロジックに集中できるようになりました。
- **一貫したエラーレスポンス:** すべてのエラーが同じ場所で処理されるため、クライアントに対して一貫した形式のエラーレスポンスを返すことが容易になります。
- **デバッグの効率化:** エラーログの出力元が一元化され、問題の追跡がしやすくなりました。

## セキュリティの強化

`advise.md`の提案に基づき、Webアプリケーションの基本的なセキュリティ対策を導入しました。

### 変更内容

- **`helmet`の導入:**
  - HTTPヘッダーを適切に設定し、XSS（クロスサイトスクリプティング）やクリックジャッキングなどの一般的な脆弱性からアプリケーションを保護します。

- **`cors`の導入:**
  - クロスオリジンリソース共有（CORS）を設定し、許可されたオリジン（今回は `http://localhost:3001`）からのリクエストのみを受け付けるようにしました。これにより、意図しないドメインからのアクセスを防ぎます。

- **`express-rate-limit`の導入:**
  - APIへのリクエストレートを制限し、特定のIPアドレスからの大量リクエスト（ブルートフォース攻撃など）からサーバーを保護します。

### 期待される効果

- **セキュリティリスクの低減:** 一般的なWebの脆弱性に対する防御層を追加し、アプリケーションの安全性を向上させました。
- **不正アクセスの防止:** リクエスト元の制御と流量制限により、悪意のある第三者による攻撃のリスクを軽減しました。

## フロントエンドの状態管理と依存関係の改善

`advise.md`の提案に基づき、フロントエンドのコード品質と開発効率を向上させるための改善を行いました。

### 変更内容

- **状態管理にReact Context APIを導入:**
  - 認証状態（ログインしているかどうかなど）をグローバルに管理するための`AuthContext`を作成しました。
  - これまでコンポーネント間でプロパティ（props）を介して行っていた状態の受け渡しをなくし、各コンポーネントが必要な状態や関数を直接Contextから取得するように変更しました。
  - `App.js`, `Login.js`, `Dashboard.js` をリファクタリングし、Contextを利用したクリーンな状態管理を実現しました。

- **依存関係の見直し:**
  - **バックエンド:** 開発時にサーバーを自動で再起動する`nodemon`を`devDependencies`として追加し、`npm start`スクリプトを整備しました。
  - **フロントエンド:** プロジェクト内で混在していた日付ライブラリを`dayjs`に統一しました。`react-big-calendar`コンポーネントで`moment.js`が使われていた箇所を`dayjs`に置き換え、不要になった`moment.js`をアンインストールしました。

### 期待される効果

- **コンポーネントの独立性向上:** propsによる複雑なデータの受け渡しが不要になり、各コンポーネントの再利用性と独立性が高まりました。
- **コードの可読性と保守性の向上:** グローバルな状態管理により、データの流れが追いやすくなり、コードがシンプルになりました。
- **開発効率の向上:** `nodemon`の導入により、バックエンドのコーディングサイクルが高速化しました。
- **バンドルサイズの削減とパフォーマンス向上:** 非推奨でサイズの大きい`moment.js`を軽量な`dayjs`に置き換えたことで、アプリケーションのパフォーマンス向上が期待できます。
